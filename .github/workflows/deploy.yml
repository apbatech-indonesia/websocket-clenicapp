name: Deploy Laravel to VPS

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.3"
                  extensions: mbstring, bcmath, xml, ctype, json, gd, pdo_mysql, curl, zip

            - name: Deploy to VPS via SFTP
              uses: wlixcc/SFTP-Deploy-Action@v1.2.4
              with:
                  username: ${{ secrets.SERVER_USER }}
                  server: ${{ secrets.SERVER_IP }}
                  port: ${{ secrets.SERVER_PORT }}
                  ssh_private_key: ${{ secrets.SERVER_SSH_KEY }}
                  local_path: "./*"
                  remote_path: "/home/clenicapp.com/public_html/ws.clenicapp.com"
                  sftp_only: true
                  args: "-o ConnectTimeout=5"

            - name: Run deployment commands
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.SERVER_IP }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  port: ${{ secrets.SERVER_PORT }}
                  script: |
                      cd /home/clenicapp.com/public_html/ws.clenicapp.com

                      # Use PHP 8.1 or higher (sesuaikan path PHP di server)
                      export PATH=/usr/local/lsws/lsphp81/bin:$PATH

                      # Install/update composer dependencies with PHP 8.1+
                      /usr/local/lsws/lsphp81/bin/php /usr/local/bin/composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

                      # Set permission tanpa sudo (user harus punya akses)
                      chmod -R 755 /home/clenicapp.com/public_html/ws.clenicapp.com
                      chmod -R 775 storage bootstrap/cache

                      # Maintenance mode ON
                      /usr/local/lsws/lsphp81/bin/php artisan down || true

                      # Migrasi & optimize
                      /usr/local/lsws/lsphp81/bin/php artisan migrate --force
                      /usr/local/lsws/lsphp81/bin/php artisan config:cache
                      /usr/local/lsws/lsphp81/bin/php artisan route:cache
                      /usr/local/lsws/lsphp81/bin/php artisan view:cache
                      /usr/local/lsws/lsphp81/bin/php artisan storage:link
                      /usr/local/lsws/lsphp81/bin/php artisan optimize:clear
                      /usr/local/lsws/lsphp81/bin/php artisan optimize

                      # Maintenance mode OFF
                      /usr/local/lsws/lsphp81/bin/php artisan up
